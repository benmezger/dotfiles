---
- name: Check if chezmoi is installed
  shell: type chezmoi &>/dev/null
  register: chezmoi_exists
  ignore_errors: yes

- name: Create temporary bin directory for chezmoi
  tempfile:
    state: directory
    suffix: bin
  when: chezmoi_exists.rc > 0
  register: chezmoi_bin

- name: Install Chezmoi
  shell: curl -sfL https://git.io/chezmoi | sh
  when: chezmoi_exists.rc > 0
  environment:
    - BINDIR: "{{ chezmoi_bin.path }}"
  args:
    warn: no

- name: Initialize dotfiles
  shell: chezmoi -S dotfiles init
  args:
    chdir: ~/
  environment:
    - PATH: "{{ chezmoi_bin.path|d('') }}:{{ ansible_env.PATH }}"
    - CI: "{{ lookup('env', 'CI') }}"

- name: Install dotfiles
  shell: chezmoi -v apply
  args:
    chdir: ~/
  environment:
    - PATH: "{{ chezmoi_bin.path|d('') }}:{{ ansible_env.PATH }}"
    - CI: "{{ lookup('env', 'CI') }}"

- name: Install zplug
  git:
    repo: https://github.com/zplug/zplug
    dest: ~/.zplug
  tags:
    - git
    - zsh

- name: Clone TPM (for Tmux)
  git:
    repo: https://github.com/tmux-plugins/tpm
    dest: ~/.tmux/plugins/tpm
  tags:
    - git
    - tmux

- name: Ensure vim directories exist
  file:
    path: ~/.vim/autoload
    state: directory
  tags:
    - vim

- name: Install Vim-Plug
  poll: 0
  async: 45
  get_url:
    url: https://raw.githubusercontent.com/junegunn/vim-plug/master/plug.vim
    dest: ~/.vim/autoload/plug.vim
  tags:
    - vim

- name: Clone base16-shell
  git:
    repo: https://github.com/chriskempson/base16-shell
    dest: ~/.config/base16-shell
  tags:
    - git

- name: Clone Emacs doom
  git:
    repo: https://github.com/hlissner/doom-emacs
    dest: ~/.emacs.d
  tags:
    - git
    - emacs

- name: Install Emacs doom packages
  command: "~/.emacs.d/bin/doom -y install"
  tags:
    - dotfiles
    - emacs

- name: Clone wallpapers
  git:
    repo: https://github.com/benmezger/wallpapers
    dest: ~/workspace/wallpapers
  tags:
    - git

- name: Install Gitmux
  shell: go get -u github.com/arl/gitmux
  environment:
    - GOPATH: "{{ ansible_env.HOME }}/workspace/go"
  args:
    warn: no
  tags:
    - deps
    - go

- name: Install Go LSP
  shell: go get -u golang.org/x/tools/gopls
  environment:
    - GOPATH: "{{ ansible_env.HOME }}/workspace/go"
  args:
    warn: no
  tags:
    - deps
    - go

- name: Install Git Changelog generator
  shell: go get -u github.com/git-chglog/git-chglog/cmd/git-chglog
  environment:
    - GOPATH: "{{ ansible_env.HOME }}/workspace/go"
  args:
    warn: no
  tags:
    - deps
    - go
